machine:
  timezone: Europe/London
  python:
    version: 2.6.9
  node:
    version: 6.4.0
  pre:
    - sudo apt-get -y install rpm libsasl2-dev libldap2-dev libssl-dev
    - sudo mkdir -p /opt/cantemo/portal/portal/plugins
    - sudo chown ubuntu /opt/cantemo/portal/portal/plugins

dependencies:
  override:
    - npm install
    - pip install -r test-requirements.txt
  cache_directories:
    - node_modules
    - "/home/ubuntu/.cache/pip"

checkout:
  post:
    - git submodule sync
    - git submodule update --init
    - for dir in `find . -maxdepth 1 -mindepth 1 -type d | awk -F '/' '{ print $2 }' | grep -v -E '^\.'`; do echo Symlinking ${dir} to build locations; ln -s ${PWD}/$dir /opt/cantemo/portal/portal/plugins;done
    - for dir in `find . -maxdepth 1 -mindepth 1 -type d | awk -F '/' '{ print $2 }' | grep -v -E '^\.'`; do echo Trying to run "${PWD}/$dir/testsetup.sh"; if [ -x "${PWD}/$dir/testsetup.sh" ]; then ${PWD}/$dir/testsetup.sh; fi; done

test:
  override:
    - declare -x PYTHONPATH=$PYTHONPATH:deps/gnmvidispine; nosetests -v gnmpagerduty/tests
    - npm run test
    - npm run testcss

deployment:
  master:
    branch: /.*/
    commands:
      - chmod a+x buildrpms.sh
      - ./buildrpms.sh
